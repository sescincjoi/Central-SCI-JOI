<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central SCI JOI - Dashboard Operacional</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(135deg, #18181b 0%, #27272a 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .header {
            background: radial-gradient(circle at center, #3f3f46 0%, #18181b 100%);
            border-bottom: 1px solid rgba(161, 161, 170, 0.2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .alert-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 4px solid transparent;
        }

        .alert-card:hover {
            transform: translateX(4px);
            border-left-color: currentColor;
        }

        .status-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.5;
                transform: scale(1.1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .sistema-card {
            position: relative;
            overflow: hidden;
        }

        .sistema-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #71717a, #52525b);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sistema-card:hover::before {
            opacity: 1;
        }

        ::-webkit-scrollbar { 
            width: 6px; 
            height: 6px;
        }

        ::-webkit-scrollbar-track { 
            background: rgba(24, 24, 27, 0.1); 
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb { 
            background: rgba(113, 113, 122, 0.5); 
            border-radius: 10px; 
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(113, 113, 122, 0.8);
        }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .count-animation {
            animation: countUp 0.4s ease-out;
        }

        .alert-hover:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
        }

        .badge-pulse {
            animation: badgePulse 1.5s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes pulse-glow {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        .animate-pulse {
            animation: pulse-glow 3s ease-in-out infinite;
        }
        
        .tabular-nums {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
        }
        
        @media (max-width: 768px) {
            #equipeAtual {
                font-size: 1.75rem !important;
            }
            
            #proximaTroca {
                font-size: 1.25rem !important;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>

    <!-- Header Compacto -->
    <div class="header">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <img src="https://lh3.googleusercontent.com/u/0/d/1qRTQ2m7853VqWVPnms99f0cPBlQHahXq" 
                     alt="Logo SCI" 
                     class="w-14 h-14 rounded-full bg-white shadow-lg"
                     onerror="this.src='https://via.placeholder.com/150x150?text=SCI';">
                <div>
                    <h1 class="text-2xl md:text-3xl font-black text-white tracking-tight">Central SCI JOI</h1>
                    <p class="text-slate-400 text-xs font-semibold tracking-widest uppercase">Sistema de Controle Integrado</p>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-1">
                <div class="text-white text-right">
                    <p id="currentDate" class="text-xs font-bold opacity-90"></p>
                    <p id="currentTime" class="text-xl md:text-2xl font-black tracking-tight"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="max-w-7xl mx-auto px-4 py-4 md:py-6">

        <!-- Banner de Equipe de Plantão Slim -->
        <div class="glass-card rounded-2xl p-3 fade-in mb-4 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-zinc-600/5 via-stone-600/5 to-zinc-600/5 animate-pulse"></div>
            
            <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-3">
                <!-- Lado Esquerdo: Info da Equipe -->
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-zinc-100 to-stone-100 p-2 rounded-lg">
                        <i data-lucide="users" class="w-5 h-5 text-zinc-700"></i>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-0.5">
                            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Equipe de Plantão</h2>
                            <div class="status-badge w-2 h-2 bg-emerald-500 rounded-full"></div>
                        </div>
                        <div id="equipeAtual" class="text-2xl md:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-zinc-700 to-stone-700">
                            CHARLIE
                        </div>
                    </div>
                </div>
        
                <!-- Centro: Contador -->
                <div class="flex flex-col items-center text-center px-4 py-1.5 bg-white/50 rounded-lg border border-slate-200">
                    <p class="text-[9px] text-slate-500 font-bold mb-0.5 uppercase tracking-wider">Troca em</p>
                    <div id="proximaTroca" class="text-lg md:text-xl font-black text-slate-800 tabular-nums">
                        --:--:--
                    </div>
                </div>
        
                <!-- Lado Direito: Próxima Equipe -->
                <div class="flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-slate-50 to-zinc-50 rounded-lg border border-zinc-200">
                    <i data-lucide="arrow-right-circle" class="w-4 h-4 text-zinc-600"></i>
                    <div>
                        <p class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">Próxima</p>
                        <p id="proximaEquipe" class="text-xs font-black text-zinc-700">
                            DELTA às 17:00
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PTR-BA Hoje - Versão Slim -->
        <div class="glass-card rounded-2xl p-4 fade-in mb-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="bg-amber-100 p-2 rounded-lg">
                        <i data-lucide="clipboard-list" class="w-5 h-5 text-amber-600"></i>
                    </div>
                    <div>
                        <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">PTR-BA Hoje</h2>
                        <p id="ptrData" class="text-[10px] text-slate-500 font-semibold">Carregando...</p>
                    </div>
                </div>
            </div>
            
            <div id="treinamentosHoje" class="space-y-2">
                <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg">
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-pulse"></div>
                    <p class="text-xs text-slate-500 italic">Carregando treinamentos...</p>
                </div>
            </div>
        </div>

        <!-- Alertas Consolidados Slim -->
        <div class="glass-card rounded-2xl p-4 mb-4 fade-in">
            <div class="flex items-center gap-2 mb-3">
                <div class="bg-red-100 p-2 rounded-lg">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
                </div>
                <div>
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Alertas Consolidados</h2>
                    <p class="text-[10px] text-slate-500 font-semibold">Atualização em tempo real</p>
                </div>
            </div>
            
            <div id="alertasContainer" class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div class="p-3 bg-slate-50 rounded-lg text-center">
                    <p class="text-xs text-slate-400 italic">Carregando alertas...</p>
                </div>
            </div>
        </div>

        <!-- Cards dos Sistemas - Versão Slim -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <!-- Card TAF -->
            <div class="glass-card flex flex-col justify-between rounded-2xl p-4 sistema-card fade-in cursor-pointer" onclick="abrirSistema('taf')">
                <div class="flex items-center gap-2 mb-3">
                    <div class="bg-gradient-to-br from-blue-800 to-blue-500 p-2 rounded-lg">
                        <i data-lucide="activity" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-slate-800 text-base">TAF</h3>
                        <p class="text-[10px] text-slate-500 font-semibold">Teste de Aptidão Física</p>
                    </div>
                </div>
                
                <div class="space-y-2 mb-3">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Taxa Aprovação</span>
                        <span id="tafAprovacao" class="text-base font-black text-emerald-600">--%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Média Nota</span>
                        <span id="tafMedia" class="text-base font-black text-zinc-600">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Alertas</span>
                        <span id="tafAlertas" class="px-2 py-0.5 bg-red-100 text-red-700 text-xs font-black rounded-full">0</span>
                    </div>
                </div>
                
                <button class="w-full bg-gradient-to-r from-blue-800 to-blue-500 text-white py-2 rounded-lg font-bold text-xs hover:shadow-lg transition-all flex items-center justify-center gap-2">
                    <span>Abrir Sistema</span>
                    <i data-lucide="arrow-right" class="w-3 h-3"></i>
                </button>
            </div>

            <!-- Card Tempo Resposta -->
            <div class="glass-card flex flex-col justify-between rounded-2xl p-4 sistema-card fade-in cursor-pointer" onclick="abrirSistema('tempo-resposta')">
                <div class="flex items-center gap-2 mb-3">
                    <div class="bg-gradient-to-br from-red-800 to-red-500 p-2 rounded-lg">
                        <i data-lucide="timer" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-slate-800 text-base">Tempo Resposta</h3>
                        <p class="text-[10px] text-slate-500 font-semibold">Exercício CCI</p>
                    </div>
                </div>
                
                <div class="space-y-2 mb-3">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Melhor Tempo</span>
                        <span id="trMelhorTempo" class="text-xs font-black text-emerald-600 truncate max-w-[120px]">--:--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Média Geral</span>
                        <span id="trMediaGeral" class="text-base font-black text-zinc-600">--:--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Total</span>
                        <span id="trTotalExercicios" class="text-base font-black text-slate-700">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Alertas</span>
                        <span id="trAlertas" class="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-black rounded-full">0</span>
                    </div>
                </div>
                
                <button class="w-full bg-gradient-to-r from-red-800 to-red-500 text-white py-2 rounded-lg font-bold text-xs hover:shadow-lg transition-all flex items-center justify-center gap-2">
                    <span>Abrir Sistema</span>
                    <i data-lucide="arrow-right" class="w-3 h-3"></i>
                </button>
            </div>

            <!-- Card Vestimenta TP/EPR -->
            <div class="glass-card flex flex-col justify-between rounded-2xl p-4 sistema-card fade-in cursor-pointer flex flex-col" onclick="abrirSistema('vestimenta')">
                <div class="flex items-center gap-2 mb-3">
                    <div class="bg-gradient-to-br from-orange-700 to-amber-500 p-2 rounded-lg">
                        <i data-lucide="shield" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-slate-800 text-base">Vestimenta TP/EPR</h3>
                        <p class="text-[10px] text-slate-500 font-semibold">Prontidão Operacional</p>
                    </div>
                </div>
                
                <div class="space-y-2 mb-3 flex-1">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Melhor Tempo</span>
                        <span id="vestMelhorTempo" class="text-xs font-black text-emerald-600 truncate max-w-[120px]">--:--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Média Geral</span>
                        <span id="vestMediaGeral" class="text-base font-black text-zinc-600">--:--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Total</span>
                        <span id="vestTotalExercicios" class="text-base font-black text-slate-700">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Alertas</span>
                        <span id="vestAlertas" class="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-black rounded-full">0</span>
                    </div>
                </div>
                
                <button class="w-full bg-gradient-to-r from-orange-700 to-amber-500 text-white py-2 rounded-lg font-bold text-xs hover:shadow-lg transition-all flex items-center justify-center gap-2 mt-auto">
                    <span>Abrir Sistema</span>
                    <i data-lucide="arrow-right" class="w-3 h-3"></i>
                </button>
            </div>

        </div>

    </div>

    <script>
        // URLs das fontes de dados
        const TAF_SPREADSHEET_ID = '1AQvblyoMbIjvoafUx92QQnBEj-DWERvDwwlMy7Q1xSo';
        const TAF_JSON_URL = `https://docs.google.com/spreadsheets/d/${TAF_SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=0`;
        
        const PTR_SPREADSHEET_ID = '1_UJdUt466IFbupbkX1ucMcsOnfbLoPp7W_B0hfbdl6o';
        const PTR_JSON_URL = `https://docs.google.com/spreadsheets/d/${PTR_SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=0`;
        
        const TR_SPREADSHEET_ID = '1MB0Q-vQ_dv27LiB0Jfblj5g5bcpLEJAMG2mE59uQ5Rg';
        const TR_JSON_URL = `https://docs.google.com/spreadsheets/d/${TR_SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=0`;

        const VEST_SPREADSHEET_ID = '1SIM3VeI1tFSyI0PA07O6QsYzDTt3nJmfEFJm9807mto';
        const VEST_JSON_URL = `https://docs.google.com/spreadsheets/d/${VEST_SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=0`;
        
        let dadosTAF = [];
        let dadosPTR = [];
        let dadosTR = [];
        let dadosVEST = [];
        
        const EQUIPES = ['ALFA', 'BRAVO', 'CHARLIE', 'DELTA'];
        const HORARIOS_TROCA = [
            { hora: 5, minuto: 0 },
            { hora: 17, minuto: 0 }
        ];
        
        const DATA_REF_FIXA = new Date('2026-01-15T17:00:00');
        const EQUIPE_REF_FIXA = 'DELTA';
        
        function calcularEquipeAtual() {
            const agora = new Date();
            const diffMs = agora - DATA_REF_FIXA;
            const diffHoras = diffMs / (1000 * 60 * 60);
            const horasPorTroca = 12;
            const trocasDesdeRef = Math.floor(diffHoras / horasPorTroca);
            const indiceRef = EQUIPES.indexOf(EQUIPE_REF_FIXA);
            const indiceAtual = (indiceRef + trocasDesdeRef) % EQUIPES.length;
            return EQUIPES[indiceAtual];
        }
        
        function calcularProximaTroca() {
            const agora = new Date();
            const hora = agora.getHours();
            let proximaTroca = new Date(agora);
            
            if (hora < 5) {
                proximaTroca.setHours(5, 0, 0, 0);
            } else if (hora < 17) {
                proximaTroca.setHours(17, 0, 0, 0);
            } else {
                proximaTroca.setDate(proximaTroca.getDate() + 1);
                proximaTroca.setHours(5, 0, 0, 0);
            }
            
            const equipeAtual = calcularEquipeAtual();
            const indiceAtual = EQUIPES.indexOf(equipeAtual);
            const proximaEquipe = EQUIPES[(indiceAtual + 1) % EQUIPES.length];
            
            return { 
                data: proximaTroca, 
                equipe: proximaEquipe,
                horario: proximaTroca.getHours() === 5 ? '05:00' : '17:00'
            };
        }
        
        function atualizarEquipePlantao() {
            const equipeAtual = calcularEquipeAtual();
            const proximaTroca = calcularProximaTroca();
            
            document.getElementById('equipeAtual').textContent = equipeAtual;
            document.getElementById('proximaEquipe').textContent = 
                `${proximaTroca.equipe} às ${proximaTroca.horario}`;
            
            atualizarContadorTroca(proximaTroca.data);
        }
        
        function atualizarContadorTroca(proximaTroca) {
            const agora = new Date();
            const diff = proximaTroca - agora;
            
            if (diff <= 0) {
                atualizarEquipePlantao();
                return;
            }
            
            const horas = Math.floor(diff / (1000 * 60 * 60));
            const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const segundos = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('proximaTroca').textContent = 
                `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
        }
        
        function atualizarRelogio() {
            const agora = new Date();
            
            const data = agora.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const hora = agora.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('currentDate').textContent = data;
            document.getElementById('currentTime').textContent = hora;
        }
        
        async function carregarDadosTAF() {
            try {
                const response = await fetch(TAF_JSON_URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const rows = json.table.rows;
        
                dadosTAF = rows.slice(1).map((row) => {
                    const cellData = row.c[0]?.f || row.c[0]?.v || "";
                    const cellNome = row.c[1]?.v || "";
                    const cellTempoTotal = row.c[8]?.f || row.c[8]?.v || "00:00:00";
                    const cellIdade = row.c[4]?.v || 0;
        
                    const tempoSeg = parseTimeToSeconds(cellTempoTotal);
                    const nota = calcularNota(tempoSeg, cellIdade);
        
                    return {
                        data: cellData,
                        dateObject: parseDate(cellData),
                        nome: cellNome,
                        idade: cellIdade,
                        tempoSeg: tempoSeg,
                        nota: nota
                    };
                }).filter(d => d.nome && d.nome !== '' && d.tempoSeg > 0);
        
                processarDadosTAF();
            } catch (error) {
                console.error("Erro ao carregar TAF:", error);
            }
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            return parts.length === 3 ? new Date(parts[2], parts[1] - 1, parts[0]) : null;
        }
        
        function parseTimeToSeconds(val) {
            if (!val) return 0;
            const parts = val.toString().split(':').map(Number);
            if (parts.length === 3) return (parts[0] * 3600) + (parts[1] * 60) + parts[2];
            if (parts.length === 2) return (parts[0] * 60) + parts[1];
            return 0;
        }
        
        function calcularNota(tempoSegundos, idade) {
            if (idade <= 40) {
                if (tempoSegundos <= 120) return 10;
                if (tempoSegundos <= 140) return 9;
                if (tempoSegundos <= 160) return 8;
                if (tempoSegundos <= 180) return 7;
                return 0;
            } else {
                if (tempoSegundos <= 180) return 10;
                if (tempoSegundos <= 200) return 9;
                if (tempoSegundos <= 220) return 8;
                if (tempoSegundos <= 240) return 7;
                return 0;
            }
        }
        
        function processarDadosTAF() {
            const ultimosTestes = {};
            dadosTAF.forEach(d => {
                if (!ultimosTestes[d.nome] || d.dateObject > ultimosTestes[d.nome].dateObject) {
                    ultimosTestes[d.nome] = d;
                }
            });
            const dados = Object.values(ultimosTestes);
        
            const aprovados = dados.filter(d => d.nota >= 7).length;
            const taxaAprovacao = ((aprovados / dados.length) * 100).toFixed(1);
            const mediaNota = (dados.reduce((acc, d) => acc + d.nota, 0) / dados.length).toFixed(1);
        
            document.getElementById('tafAprovacao').textContent = `${taxaAprovacao}%`;
            document.getElementById('tafMedia').textContent = mediaNota;
        
            gerarAlertasTAF(dados);
        }
        
        function gerarAlertasTAF(dados) {
            const alertas = [];
            const hoje = new Date();
        
            const reprovados = dados.filter(d => d.nota < 7);
            if (reprovados.length > 0) {
                alertas.push({
                    sistema: 'TAF',
                    tipo: 'reprovados',
                    prioridade: 'alta',
                    icone: 'x-circle',
                    cor: 'red',
                    titulo: 'Reprovações no TAF',
                    mensagem: `${reprovados.length} bombeiro(s) reprovado(s)`,
                    quantidade: reprovados.length
                });
            }
        
            const limitrofe = dados.filter(d => d.nota === 7);
            if (limitrofe.length > 0) {
                alertas.push({
                    sistema: 'TAF',
                    tipo: 'limitrofe',
                    prioridade: 'media',
                    icone: 'alert-triangle',
                    cor: 'amber',
                    titulo: 'Desempenho Limítrofe',
                    mensagem: `${limitrofe.length} bombeiro(s) com nota mínima`,
                    quantidade: limitrofe.length
                });
            }
        
            const vencidos = dados.filter(d => {
                if (!d.dateObject) return false;
                const diffDias = Math.floor((hoje - d.dateObject) / (1000 * 60 * 60 * 24));
                return diffDias > 90;
            });
            if (vencidos.length > 0) {
                alertas.push({
                    sistema: 'TAF',
                    tipo: 'vencidos',
                    prioridade: 'alta',
                    icone: 'calendar-x',
                    cor: 'orange',
                    titulo: 'Testes Vencidos',
                    mensagem: `${vencidos.length} teste(s) vencido(s) há +90 dias`,
                    quantidade: vencidos.length
                });
            }
        
            const totalAlertas = alertas.length;
            document.getElementById('tafAlertas').textContent = totalAlertas;
        
            renderizarAlertas(alertas);
        }
        
        async function carregarPTR() {
            try {
                const response = await fetch(PTR_JSON_URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const rows = json.table.rows;
        
                const headerRow = rows[0];
                const mesAtual = headerRow.c[0]?.v || "";
        
                const hoje = new Date();
                const diaHoje = hoje.getDate();
        
                let treinamentosHoje = [];
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const dia = row.c[0]?.v || "";
                    
                    if (parseInt(dia) === diaHoje) {
                        for (let col = 1; col <= 4; col++) {
                            const treinamento = row.c[col]?.v || "";
                            if (treinamento && treinamento.trim() !== "") {
                                treinamentosHoje.push(treinamento);
                            }
                        }
                        break;
                    }
                }
        
                document.getElementById('ptrData').textContent = 
                    `${diaHoje}/${mesAtual.split('/')[0]}`;
                
                renderizarTreinamentos(treinamentosHoje);
            } catch (error) {
                console.error("Erro ao carregar PTR:", error);
                document.getElementById('treinamentosHoje').innerHTML = 
                    '<div class="p-2 bg-red-50 rounded-lg text-xs text-red-700">Erro ao carregar treinamentos</div>';
            }
        }
        
        function renderizarTreinamentos(treinamentos) {
            const container = document.getElementById('treinamentosHoje');
            
            if (treinamentos.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center gap-2 p-2 bg-emerald-50 rounded-lg border border-emerald-100">
                        <i data-lucide="check-circle" class="w-4 h-4 text-emerald-600"></i>
                        <p class="text-xs text-emerald-700 font-semibold">Sem treinamentos agendados para hoje</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
        
            const cores = ['blue', 'purple', 'emerald', 'amber'];
            
            container.innerHTML = treinamentos.map((t, index) => `
                <div class="flex items-start gap-2 p-2 bg-${cores[index]}-50 rounded-lg border border-${cores[index]}-100">
                    <div class="bg-${cores[index]}-100 p-1.5 rounded-md flex-shrink-0">
                        <i data-lucide="bookmark" class="w-3 h-3 text-${cores[index]}-600"></i>
                    </div>
                    <p class="text-xs text-${cores[index]}-900 font-semibold leading-relaxed">${t}</p>
                </div>
            `).join('');
            
            lucide.createIcons();
        }
        
        async function carregarDadosTR() {
            try {
                const query = encodeURIComponent('Select B, C, D, G, H offset 2');
                const url = `https://docs.google.com/spreadsheets/d/${TR_SPREADSHEET_ID}/gviz/tq?tq=${query}&headers=0`;
                
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                
                dadosTR = json.table.rows.map((row) => {
                    const rawDate = row.c[0] ? (row.c[0].f || row.c[0].v) : null;
                    return {
                        dataStr: rawDate,
                        dataObj: parseDateTR(rawDate),
                        equipe: row.c[1] ? row.c[1].v : null,
                        local: row.c[2] ? row.c[2].v : 'N/A',
                        tempo1: parseDurationTR(row.c[3]),
                        tempoFinal: parseDurationTR(row.c[4])
                    };
                }).filter(d => 
                    d.equipe !== null && 
                    d.dataObj !== null && 
                    (d.tempo1 > 0 || d.tempoFinal > 0)
                );
                
                processarDadosTR();
            } catch (error) {
                console.error("Erro ao carregar Tempo Resposta:", error);
            }
        }
        
        function parseDateTR(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            return parts.length === 3 
                ? new Date(parts[2], parts[1] - 1, parts[0], 12, 0, 0)
                : new Date(dateStr);
        }
        
        function parseDurationTR(cell) {
            if (!cell) return 0;
            if (cell.f && cell.f.includes(':')) {
                const parts = cell.f.split(':');
                if (parts.length === 3) {
                    return (+parts[0]) * 3600 + (+parts[1]) * 60 + (+parts[2]);
                }
                if (parts.length === 2) {
                    return (+parts[0]) * 60 + (+parts[1]);
                }
            }
            if (typeof cell.v === 'number') {
                return cell.v < 1 ? Math.round(cell.v * 86400) : Math.round(cell.v);
            }
            return 0;
        }
        
        function formatTimeTR(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) return "0:00";
            const m = Math.floor(totalSeconds / 60);
            const s = Math.round(totalSeconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }
        
        function processarDadosTR() {
            if (dadosTR.length === 0) {
                document.getElementById('trMelhorTempo').textContent = '--:--';
                document.getElementById('trMediaGeral').textContent = '--:--';
                document.getElementById('trTotalExercicios').textContent = '0';
                document.getElementById('trAlertas').textContent = '0';
                return;
            }
        
            const equipes = [...new Set(dadosTR.map(d => d.equipe))];
            
            let melhorTempo = Infinity;
            let melhorEquipe = '--';
            let somaMedias = 0;
            
            equipes.forEach(eq => {
                const items = dadosTR.filter(f => f.equipe === eq);
                const media = items.reduce((s, x) => s + x.tempoFinal, 0) / items.length;
                somaMedias += media;
                
                if (media < melhorTempo) {
                    melhorTempo = media;
                    melhorEquipe = eq;
                }
            });
            
            const mediaGeral = somaMedias / equipes.length;
            
            document.getElementById('trMelhorTempo').textContent = 
                `${melhorEquipe} (${formatTimeTR(melhorTempo)})`;
            document.getElementById('trMediaGeral').textContent = formatTimeTR(mediaGeral);
            document.getElementById('trTotalExercicios').textContent = dadosTR.length;
            
            gerarAlertasTR(dadosTR, mediaGeral);
        }
        
        function gerarAlertasTR(dados, mediaGeral) {
            const alertas = [];
            
            const acimaDaMedia = dados.filter(d => d.tempoFinal > mediaGeral);
            if (acimaDaMedia.length > 0) {
                alertas.push({
                    sistema: 'Tempo Resposta',
                    tipo: 'acima_media',
                    prioridade: 'media',
                    icone: 'clock',
                    cor: 'amber',
                    titulo: 'Tempos Acima da Média',
                    mensagem: `${acimaDaMedia.length} exercício(s) acima da média geral`,
                    quantidade: acimaDaMedia.length
                });
            }
            
            const criticos = dados.filter(d => d.tempoFinal > 180);
            if (criticos.length > 0) {
                alertas.push({
                    sistema: 'Tempo Resposta',
                    tipo: 'criticos',
                    prioridade: 'alta',
                    icone: 'alert-circle',
                    cor: 'red',
                    titulo: 'Tempos Críticos',
                    mensagem: `${criticos.length} exercício(s) acima de 3 minutos`,
                    quantidade: criticos.length
                });
            }
            
            const totalAlertas = alertas.length;
            document.getElementById('trAlertas').textContent = totalAlertas;
        }

        async function carregarDadosVEST() {
            try {
                const response = await fetch(VEST_JSON_URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const rows = json.table.rows;
                
                dadosVEST = rows.slice(1).map((row) => {
                    const rawDate = row.c[1] ? (row.c[1].f || row.c[1].v) : null;
                    const rawEquipe = row.c[2] ? row.c[2].v : null;
                    const rawNome = row.c[3] ? row.c[3].v : null;
                    const rawTempo = row.c[4] ? (row.c[4].f || row.c[4].v) : null;
                    
                    return {
                        dataStr: rawDate,
                        dataObj: parseDateTR(rawDate),
                        equipe: rawEquipe,
                        nome: rawNome,
                        tempoSegundos: parseDurationTR(row.c[4])
                    };
                }).filter(d => 
                    d.nome !== null && 
                    d.nome !== 'Nome' &&
                    d.nome !== '' &&
                    d.dataObj !== null && 
                    d.tempoSegundos > 0
                );
                
                processarDadosVEST();
            } catch (error) {
                console.error("Erro ao carregar Vestimenta TP/EPR:", error);
            }
        }
        
        function processarDadosVEST() {
            if (dadosVEST.length === 0) {
                document.getElementById('vestMelhorTempo').textContent = '--:--';
                document.getElementById('vestMediaGeral').textContent = '--:--';
                document.getElementById('vestTotalExercicios').textContent = '0';
                document.getElementById('vestAlertas').textContent = '0';
                return;
            }
        
            const sorted = [...dadosVEST].sort((a, b) => a.tempoSegundos - b.tempoSegundos);
            const melhorRegistro = sorted[0];
            const melhorTempo = melhorRegistro.tempoSegundos;
            const melhorBA = melhorRegistro.nome;
            
            const mediaGeral = dadosVEST.reduce((acc, curr) => acc + curr.tempoSegundos, 0) / dadosVEST.length;
            
            document.getElementById('vestMelhorTempo').textContent = 
                `${melhorBA} (${formatTimeTR(melhorTempo)})`;
            document.getElementById('vestMediaGeral').textContent = formatTimeTR(mediaGeral);
            document.getElementById('vestTotalExercicios').textContent = dadosVEST.length;
            
            gerarAlertasVEST(dadosVEST, mediaGeral);
        }
        
        function gerarAlertasVEST(dados, mediaGeral) {
            const alertas = [];
            const OBJETIVO_VEST = 60;
            
            const acimaDaMedia = dados.filter(d => d.tempoSegundos > mediaGeral);
            if (acimaDaMedia.length > 0) {
                alertas.push({
                    sistema: 'Vestimenta TP/EPR',
                    tipo: 'acima_media',
                    prioridade: 'media',
                    icone: 'clock',
                    cor: 'amber',
                    titulo: 'Tempos Acima da Média',
                    mensagem: `${acimaDaMedia.length} exercício(s) acima da média geral`,
                    quantidade: acimaDaMedia.length
                });
            }
            
            const criticos = dados.filter(d => d.tempoSegundos > 90);
            if (criticos.length > 0) {
                alertas.push({
                    sistema: 'Vestimenta TP/EPR',
                    tipo: 'criticos',
                    prioridade: 'alta',
                    icone: 'alert-circle',
                    cor: 'red',
                    titulo: 'Tempos Críticos',
                    mensagem: `${criticos.length} exercício(s) acima de 1:30`,
                    quantidade: criticos.length
                });
            }
            
            if (mediaGeral > OBJETIVO_VEST) {
                alertas.push({
                    sistema: 'Vestimenta TP/EPR',
                    tipo: 'objetivo',
                    prioridade: 'media',
                    icone: 'target',
                    cor: 'orange',
                    titulo: 'Objetivo Operacional',
                    mensagem: `Média geral (${formatTimeTR(mediaGeral)}) acima do objetivo (01:00)`,
                    quantidade: 1
                });
            }
            
            const totalAlertas = alertas.length;
            document.getElementById('vestAlertas').textContent = totalAlertas;
        }
        
        function renderizarAlertas(alertas) {
            const container = document.getElementById('alertasContainer');
            
            if (alertas.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 p-4 bg-emerald-50 rounded-lg border-2 border-emerald-100 text-center">
                        <i data-lucide="check-circle-2" class="w-12 h-12 text-emerald-600 mx-auto mb-2"></i>
                        <p class="text-base font-black text-emerald-800">Sistema Operacional</p>
                        <p class="text-xs text-emerald-600 font-semibold mt-1">Nenhum alerta no momento</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
        
            container.innerHTML = alertas.map(a => `
                <div class="alert-card alert-hover p-3 bg-${a.cor}-50 rounded-lg border-l-4 border-${a.cor}-500" data-sistema="${a.sistema}">
                    <div class="flex items-start gap-2">
                        <div class="bg-${a.cor}-100 p-1.5 rounded-md flex-shrink-0">
                            <i data-lucide="${a.icone}" class="w-4 h-4 text-${a.cor}-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-0.5">
                                <p class="text-[10px] font-black text-${a.cor}-600 uppercase tracking-wider">${a.sistema}</p>
                                <span class="px-2 py-0.5 bg-${a.cor}-100 text-${a.cor}-700 text-xs font-black rounded-full badge-pulse">${a.quantidade}</span>
                            </div>
                            <p class="text-xs font-bold text-slate-800">${a.titulo}</p>
                            <p class="text-[10px] text-slate-600 font-semibold mt-0.5">${a.mensagem}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }
        
        function abrirSistema(sistema) {
            if (sistema === 'taf') {
                window.location.href = 'taf.html';
            } else if (sistema === 'tempo-resposta') {
                window.location.href = 'Tempo-Resposta.html';
            } else if (sistema === 'vestimenta') {
                window.location.href = 'Tempo-TP-EPR.html';
            }
        }
        
        function init() {
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
            
            atualizarEquipePlantao();
            setInterval(atualizarEquipePlantao, 1000);
            
            carregarDadosTAF();
            carregarPTR();
            carregarDadosTR();
            carregarDadosVEST();
            
            setInterval(carregarDadosTAF, 5 * 60 * 1000);
            setInterval(carregarPTR, 5 * 60 * 1000);
            setInterval(carregarDadosTR, 5 * 60 * 1000);
            setInterval(carregarDadosVEST, 5 * 60 * 1000);
            
            lucide.createIcons();
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
