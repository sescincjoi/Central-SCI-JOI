<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Extrator Offline de Ocorrências</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
body { font-family: Arial; padding:20px; background:#f0f0f0; }
.container { background:white; padding:20px; border-radius:8px; }
textarea { width:100%; height:250px; margin-top:15px; }
button { padding:10px 15px; margin-top:10px; cursor:pointer; }
</style>
</head>
<body>

<div class="container">
<h2>Extrator Offline de Ocorrências</h2>

<input type="file" id="images" multiple accept="image/*"><br>
<button onclick="processar()">Processar</button>
<button onclick="copiar()">Copiar Resultado</button>

<textarea id="resultado" placeholder="As linhas aparecerão aqui..."></textarea>
</div>

<script>

async function processar() {

const files = document.getElementById("images").files;
const resultadoArea = document.getElementById("resultado");
resultadoArea.value = "Processando...\n";

for (let i = 0; i < files.length; i++) {

const { data: { text } } = await Tesseract.recognize(
files[i],
'por',
{ logger: m => console.log(m) }
);

const linha = extrairDados(text);
resultadoArea.value += linha + "\n";
}

}

function extrairDados(texto) {

function limpar(txt){
return txt ? txt.replace(/\n/g," ").replace(/\s+/g," ").trim() : "";
}

const data = texto.match(/Data:\s*(\d{2}\/\d{2}\/\d{4})/)?.[1] || "";
const relatorio = texto.match(/Relatório\s*nº:\s*(\d+)/i)?.[1] || "";
const tipo = limpar(texto.match(/TIPO DE OCORRÊNCIA:\s*(.*)/)?.[1]);
const equipe = limpar(texto.match(/Equipe:\s*(.*)/)?.[1]);

let procedimentosMatch = texto.match(/Procedimentos estabelecidos:\s*([\s\S]*)/i);
let procedimentos = limpar(procedimentosMatch ? procedimentosMatch[1] : "");

procedimentos = corrigirTexto(procedimentos);

const resumo = gerarResumo(procedimentos);

return `${data}\t${relatorio}\t${tipo}\t${equipe}\t${resumo}\t${procedimentos}`;
}

function gerarResumo(texto){
if(!texto) return "";
let frase = texto.split(". ")[0];
return frase.endsWith(".") ? frase : frase + ".";
}

function corrigirTexto(texto){
return texto
.replace(/às/g,"Às")
.replace(/viatura crs/gi,"viatura CRS")
.replace(/sessão contra incêndio/gi,"Seção Contra Incêndio")
.replace(/\s+/g," ")
.trim();
}

function copiar(){
const textarea = document.getElementById("resultado");
textarea.select();
document.execCommand("copy");
alert("Copiado!");
}

</script>

</body>
</html>
